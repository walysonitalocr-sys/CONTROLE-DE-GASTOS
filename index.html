<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meus Gastos ‚Äî Meus Gastos</title>

  <!-- Tailwind CDN r√°pido -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel para JSX no browser (somente para prot√≥tipo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --g1: #10b981; /* green */
      --g2: #3b82f6; /* blue */
    }
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .brand-gradient { background: linear-gradient(135deg, var(--g1), var(--g2)); }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(6px); }
    /* micro-animations */
    .pulse-fast { animation: pulse 1.2s infinite; }
    .card-anim { transform-origin: center; transition: transform .18s ease, box-shadow .18s ease; }
    .card-anim:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(16,24,40,0.12); }
    /* mobile app-like container */
    @media (max-width: 768px) {
      .app-shell { padding: 18px; }
    }
    canvas { max-width: 100% !important; height: auto !important; }
  </style>
</head>
<body class="bg-gradient-to-b from-white to-slate-50 dark:from-gray-900 dark:to-slate-900 text-slate-900 dark:text-slate-100">

<div id="root"></div>

<script type="text/babel">
/* Meus Gastos - √∫nico arquivo React + Tailwind + Chart.js */
/* globals React, ReactDOM, Chart */

const { useState, useEffect, useMemo, useRef } = React;

/* ---------- CONFIG ---------- */
const APP_NAME = "Meus Gastos";
const PROFILE_KEY = "meus_gastos_profile_v1";
const TX_KEY = "meus_gastos_transactions_v1";

/* ---------- categorias ---------- */
const CATEGORIES = [
  { id: 'alimentacao', name: 'Alimenta√ß√£o' },
  { id: 'transporte', name: 'Transporte' },
  { id: 'lazer', name: 'Lazer' },
  { id: 'moradia', name: 'Moradia' },
  { id: 'cartoes', name: 'Cart√µes' },
  { id: 'faculdade', name: 'Faculdade' },
  { id: 'internet', name: 'Internet' },
  { id: 'luz', name: 'Luz' },
  { id: 'agua', name: '√Ågua' },
  { id: 'saude', name: 'Sa√∫de' },
  { id: 'outros', name: 'Outros' },
];

/* ---------- util ---------- */
function genId(){ return 'id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8); }
function monthKeyFromDate(dateStr){ return dateStr ? dateStr.slice(0,7) : new Date().toISOString().slice(0,7); }
function addOneMonthToDate(dateStr){
  const d = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
  const day = d.getDate(), m = d.getMonth(), y = d.getFullYear();
  let nm = m + 1, ny = y;
  if (nm > 11) { nm = 0; ny = y + 1; }
  const cand = new Date(ny, nm, day);
  if (cand.getMonth() !== nm) {
    const lastDay = new Date(ny, nm+1, 0).getDate();
    return `${ny}-${String(nm+1).padStart(2,'0')}-${String(lastDay).padStart(2,'0')}`;
  }
  return `${ny}-${String(nm+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
}

/* ---------- storage ---------- */
function loadProfile(){ try{ const raw = localStorage.getItem(PROFILE_KEY); return raw ? JSON.parse(raw) : null }catch{return null} }
function saveProfile(p){ try{ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }catch{} }
function loadTransactions(){
  try{
    const raw = localStorage.getItem(TX_KEY);
    if(!raw){
      // exemplo inicial
      return [
        { id: genId(), type:'income', category:'outros', amount:2500, date:'2025-10-01', description:'Sal√°rio', fixed:false },
        { id: genId(), type:'expense', category:'luz', amount:120, date:'2025-10-05', description:'Conta de luz', fixed:true },
        { id: genId(), type:'expense', category:'agua', amount:60, date:'2025-10-06', description:'Conta de √°gua', fixed:true },
        { id: genId(), type:'expense', category:'internet', amount:99.9, date:'2025-10-10', description:'Internet', fixed:true },
        { id: genId(), type:'expense', category:'alimentacao', amount:45.5, date:'2025-10-25', description:'Almo√ßo', fixed:false },
      ];
    }
    return JSON.parse(raw);
  }catch(e){ console.error(e); return []; }
}
function saveTransactions(data){ try{ localStorage.setItem(TX_KEY, JSON.stringify(data)); }catch(e){ console.error(e); }}

/* ---------- Theme toggle component ---------- */
function ThemeToggle(){
  const [dark, setDark] = useState(()=> localStorage.getItem('theme') === 'dark');
  useEffect(()=> {
    const root = document.documentElement;
    if(dark) root.classList.add('dark'); else root.classList.remove('dark');
    localStorage.setItem('theme', dark ? 'dark' : 'light');
  }, [dark]);
  return (
    <button onClick={()=> setDark(d => !d)} className="p-2 rounded-md bg-white/80 dark:bg-slate-800 border border-white/10 hover:scale-105 transition-transform">
      {dark ? 'üåô' : '‚òÄÔ∏è'}
    </button>
  );
}

/* ---------- Charts ---------- */
function PieCanvas({ data }){
  const ref = useRef(null), chartRef = useRef(null);
  useEffect(()=> {
    const labels = data.map(d=>d.name), vals = data.map(d=>d.value);
    const colors = ['#10B981','#059669','#06B6D4','#3B82F6','#60A5FA','#7DD3FC','#0EA5A9','#34D399','#FBBF24'];
    if(chartRef.current) chartRef.current.destroy();
    chartRef.current = new Chart(ref.current, {
      type:'pie',
      data: { labels, datasets:[{ data:vals, backgroundColor: colors.slice(0, vals.length) }] },
      options: { plugins:{ legend:{ position: 'bottom' } } }
    });
    return ()=> chartRef.current && chartRef.current.destroy();
  }, [data]);
  return <canvas ref={ref} className="w-full h-44" />;
}
function BarCanvas({ data }){
  const ref = useRef(null), chartRef = useRef(null);
  useEffect(()=> {
    const labels = data.map(d=>d.label), vals = data.map(d=>d.value);
    if(chartRef.current) chartRef.current.destroy();
    chartRef.current = new Chart(ref.current, {
      type:'bar',
      data: { labels, datasets:[{ label:'R$', data:vals, backgroundColor:'#3B82F6' }] },
      options: { plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
    return ()=> chartRef.current && chartRef.current.destroy();
  }, [data]);
  return <canvas ref={ref} className="w-full h-44" />;
}

/* ---------- TransactionForm ---------- */
function TransactionForm({ onAdd, editing, onUpdate, onCancel }){
  const [form, setForm] = useState({ type:'expense', category:'alimentacao', amount:'', date:'', description:'', fixed:false });
  useEffect(()=> { if(editing) setForm(editing); else setForm({ type:'expense', category:'alimentacao', amount:'', date:'', description:'', fixed:false }); }, [editing]);

  function handle(e){
    const { name, value, type, checked } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
  }
  function submit(e){
    e.preventDefault();
    if(!form.amount || isNaN(Number(form.amount))) return alert('Digite um valor v√°lido');
    const payload = { ...form, id: form.id || genId(), amount: Number(form.amount), date: form.date || new Date().toISOString().slice(0,10) };
    editing ? onUpdate(payload) : onAdd(payload);
    setForm({ type:'expense', category:'alimentacao', amount:'', date:'', description:'', fixed:false });
  }

  return (
    <form onSubmit={submit} className="card card-anim">
      <h3 className="font-semibold mb-2">{editing ? 'Editar transa√ß√£o' : 'Nova transa√ß√£o'}</h3>
      <div className="grid grid-cols-2 gap-2 mb-2">
        <select name="type" value={form.type} onChange={handle} className="p-2 rounded bg-gray-100 dark:bg-slate-700">
          <option value="expense">Despesa</option>
          <option value="income">Receita</option>
        </select>
        <select name="category" value={form.category} onChange={handle} className="p-2 rounded bg-gray-100 dark:bg-slate-700">
          {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
        </select>
      </div>

      <input name="amount" value={form.amount} onChange={handle} placeholder="Valor (ex: 45.50)" className="w-full p-2 rounded mb-2 bg-gray-100 dark:bg-slate-700" />
      <input name="date" type="date" value={form.date} onChange={handle} className="w-full p-2 rounded mb-2 bg-gray-100 dark:bg-slate-700" />
      <input name="description" value={form.description} onChange={handle} placeholder="Descri√ß√£o (opcional)" className="w-full p-2 rounded mb-2 bg-gray-100 dark:bg-slate-700" />

      <label className="flex items-center gap-2 text-sm mb-3">
        <input type="checkbox" name="fixed" checked={form.fixed} onChange={handle} />
        <span>Marcar como despesa fixa</span>
      </label>

      <div className="flex gap-2">
        <button type="submit" className="flex-1 py-2 rounded bg-gradient-to-r from-green-500 to-blue-500 text-white hover:scale-102 transition-transform">{editing ? 'Atualizar' : 'Adicionar'}</button>
        {editing && <button type="button" onClick={onCancel} className="px-3 py-2 rounded bg-gray-200 dark:bg-slate-700">Cancelar</button>}
      </div>
    </form>
  );
}

/* ---------- TransactionList ---------- */
function TransactionList({ transactions, onEdit, onDelete, onToggleFixed }){
  function catName(id){ return CATEGORIES.find(c => c.id === id)?.name || id; }
  return (
    <div className="card mt-4 card-anim">
      <h3 className="font-semibold mb-3">Hist√≥rico</h3>
      <div className="space-y-2 max-h-64 overflow-auto">
        {transactions.length === 0 && <div className="text-sm text-gray-500">Nenhuma transa√ß√£o neste m√™s.</div>}
        {transactions.map(t => (
          <div key={t.id} className="flex items-center justify-between p-2 rounded hover:bg-gray-100 dark:hover:bg-slate-700">
            <div>
              <div className="text-sm font-medium">{t.description || catName(t.category)}</div>
              <div className="text-xs text-gray-500">{catName(t.category)} ‚Ä¢ {t.date}</div>
            </div>

            <div className="flex items-center gap-3">
              <div className={`${t.type === 'income' ? 'text-green-600' : 'text-red-500'} font-semibold`}>R$ {Number(t.amount).toFixed(2)}</div>

              <label title="Despesa fixa" className="flex items-center gap-1 text-xs">
                <input type="checkbox" checked={!!t.fixed} onChange={() => onToggleFixed(t.id)} />
              </label>

              <button onClick={() => onEdit(t)} className="text-sm text-blue-500">Editar</button>
              <button onClick={() => { if(confirm('Excluir essa transa√ß√£o?')) onDelete(t.id) }} className="text-sm text-red-500">Excluir</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ---------- Profile (cadastro inicial) ---------- */
function ProfileForm({ onSave }){
  const [name, setName] = useState('');
  const [dob, setDob] = useState('');
  function submit(e){ e.preventDefault(); if(!name) return alert('Digite seu nome'); onSave({ name, dob }); }
  return (
    <form onSubmit={submit} className="space-y-3">
      <input value={name} onChange={e => setName(e.target.value)} placeholder="Seu nome" className="w-full p-3 rounded" />
      <input value={dob} onChange={e => setDob(e.target.value)} type="date" className="w-full p-3 rounded" />
      <button className="w-full py-3 rounded bg-gradient-to-r from-green-500 to-blue-500 text-white">Come√ßar</button>
    </form>
  );
}

/* ---------- Import button ---------- */
function ImportButton({ onImport }){
  const ref = useRef(null);
  function handleFile(e){
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => onImport(reader.result);
    reader.readAsText(file);
    e.target.value = '';
  }
  return (<>
    <input ref={ref} type="file" accept="application/json" className="hidden" onChange={handleFile} />
    <button onClick={() => ref.current.click()} className="px-3 py-2 rounded bg-white/80 dark:bg-slate-800 border">Importar JSON</button>
  </>);
}

/* ---------- Main App ---------- */
function App(){
  const [profile, setProfile] = useState(()=> loadProfile());
  const [transactions, setTransactions] = useState(()=> loadTransactions());
  const [editing, setEditing] = useState(null);
  const [selectedMonth, setSelectedMonth] = useState(()=> new Date().toISOString().slice(0,7));

  // persist
  useEffect(()=> saveProfile(profile), [profile]);
  useEffect(()=> saveTransactions(transactions), [transactions]);

  // transactions for selected month
  const transactionsForMonth = useMemo(()=> {
    return transactions.filter(t => monthKeyFromDate(t.date) === selectedMonth).sort((a,b)=> b.date.localeCompare(a.date));
  }, [transactions, selectedMonth]);

  // totals
  const totalForMonth = useMemo(()=> transactionsForMonth.reduce((s,t)=> t.type==='income' ? s + t.amount : s - t.amount, 0), [transactionsForMonth]);

  // pie data (expenses by category)
  const byCategoryForMonth = useMemo(()=> {
    const map = {}; CATEGORIES.forEach(c => map[c.id] = 0);
    transactionsForMonth.forEach(t => { if(t.type==='expense') map[t.category] += t.amount });
    return CATEGORIES.map(c => ({ name: c.name, value: map[c.id] })).filter(d => d.value > 0);
  }, [transactionsForMonth]);

  // bar data (per day)
  const barDataForMonth = useMemo(()=> {
    const map = {};
    transactionsForMonth.forEach(t => {
      const day = t.date.slice(8,10);
      map[day] = (map[day] || 0) + (t.type === 'expense' ? t.amount : -t.amount);
    });
    return Object.entries(map).sort((a,b)=> a[0]-b[0]).map(([k,v])=> ({ label:k, value:v }));
  }, [transactionsForMonth]);

  // available months from transactions + current
  const availableMonths = useMemo(()=> {
    const s = new Set(transactions.map(t => monthKeyFromDate(t.date)));
    s.add(new Date().toISOString().slice(0,7));
    return Array.from(s).filter(Boolean).sort().reverse();
  }, [transactions]);

  // actions
  function addTransaction(tx){ setTransactions(prev => [tx, ...prev]); }
  function updateTransaction(u){ setTransactions(prev => prev.map(p => p.id === u.id ? u : p)); setEditing(null); }
  function deleteTransaction(id){ setTransactions(prev => prev.filter(p => p.id !== id)); }
  function toggleFixed(id){ setTransactions(prev => prev.map(p => p.id === id ? { ...p, fixed: !p.fixed } : p)); }

  // copy fixed to next month
  function copyFixedToNextMonth(){
    const fixed = transactionsForMonth.filter(t => t.fixed);
    if(fixed.length === 0) return alert('N√£o h√° despesas fixas no m√™s selecionado.');
    const nextMonth = (()=>{ const [y,m] = selectedMonth.split('-').map(Number); let nm = m+1, ny = y; if(nm>12){ nm=1; ny+=1 } return `${ny}-${String(nm).padStart(2,'0')}` })();
    const newItems = fixed.map(t => ({ ...t, id: genId(), date: addOneMonthToDate(t.date) }));
    // check duplicates (same description+amount+category in next month)
    const duplicates = newItems.filter(ni => transactions.some(ex => monthKeyFromDate(ex.date) === nextMonth && ex.description === ni.description && ex.amount === ni.amount && ex.category === ni.category));
    if(duplicates.length > 0){
      if(!confirm(`Existem ${duplicates.length} item(ns) iguais no pr√≥ximo m√™s. Deseja adicionar mesmo assim?`)) {
        const nonDup = newItems.filter(ni => !duplicates.some(d => d.description === ni.description && d.amount === ni.amount && d.category === ni.category));
        if(nonDup.length > 0) setTransactions(prev => [...nonDup, ...prev]);
        return;
      }
    }
    setTransactions(prev => [...newItems, ...prev]);
    alert('Despesas fixas copiadas para o pr√≥ximo m√™s.');
  }

  // export/import
  function exportJSON(){ const blob = new Blob([JSON.stringify(transactions, null, 2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='meus_gastos_backup.json'; a.click(); URL.revokeObjectURL(url); }
  function importJSONString(str){ try{ const parsed = JSON.parse(str); if(!Array.isArray(parsed)) throw new Error('Formato inv√°lido'); const fixed = parsed.map(p => ({ id: p.id || genId(), type: p.type, category: p.category || 'outros', amount: Number(p.amount) || 0, date: p.date || new Date().toISOString().slice(0,10), description: p.description || '', fixed: !!p.fixed })); setTransactions(prev => [...fixed, ...prev]); alert('Importado com sucesso'); }catch(e){ alert('Erro ao importar: ' + e.message) } }

  // navigation helper
  function gotoPrevMonth(){ const [y,m] = selectedMonth.split('-').map(Number); let nm = m-1, ny = y; if(nm<1){ nm=12; ny-=1 } setSelectedMonth(`${ny}-${String(nm).padStart(2,'0')}`); }
  function gotoNextMonth(){ const [y,m] = selectedMonth.split('-').map(Number); let nm = m+1, ny = y; if(nm>12){ nm=1; ny+=1 } setSelectedMonth(`${ny}-${String(nm).padStart(2,'0')}`); }

  if(!profile){
    // show onboarding
    return (
      <div className="min-h-screen flex items-center justify-center app-shell p-6">
        <div className="w-full max-w-md rounded-3xl p-6 brand-gradient text-white shadow-lg">
          <h1 className="text-3xl font-bold mb-2">{APP_NAME}</h1>
          <p className="opacity-90 mb-4">Crie seu perfil r√°pido para come√ßar a controlar suas finan√ßas.</p>
          <ProfileForm onSave={(p)=>{ setProfile(p); saveProfile(p); }} />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-6 app-shell">
      <div className="max-w-6xl mx-auto">
        <header className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-3">
              <span className="rounded-full w-10 h-10 flex items-center justify-center bg-white/20 text-white">{APP_NAME.split(' ')[0][0]}</span>
              {APP_NAME}
            </h1>
            <div className="text-sm text-gray-600 dark:text-gray-300">Ol√°, <strong>{profile.name}</strong> üëã</div>
          </div>

          <div className="flex items-center gap-2">
            <div className="flex items-center gap-1 bg-white/90 dark:bg-slate-800 p-2 rounded shadow">
              <button onClick={gotoPrevMonth} className="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-slate-700">‚óÄ</button>
              <input type="month" value={selectedMonth} onChange={e=> setSelectedMonth(e.target.value)} className="bg-transparent text-sm" />
              <button onClick={gotoNextMonth} className="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-slate-700">‚ñ∂</button>
            </div>

            <button onClick={copyFixedToNextMonth} className="px-3 py-2 rounded bg-amber-500 text-white hover:brightness-95">Copiar fixas ‚Üí pr√≥ximo m√™s</button>
            <button onClick={exportJSON} className="px-3 py-2 rounded bg-white/80 dark:bg-slate-800">Exportar</button>
            <ImportButton onImport={(txt)=> importJSONString(txt)} />
            <ThemeToggle />
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <aside className="lg:col-span-1">
            <TransactionForm onAdd={(t)=> addTransaction(t)} editing={editing} onUpdate={updateTransaction} onCancel={()=> setEditing(null)} />
            <div className="mt-4 flex gap-2">
              <button onClick={()=> { if(confirm('Limpar todas as transa√ß√µes?')) setTransactions([]); }} className="flex-1 py-2 rounded bg-red-500 text-white">Limpar tudo</button>
              <button onClick={()=> { setTransactions(loadTransactions()); alert('Exemplo restaurado') }} className="flex-1 py-2 rounded bg-white/80 dark:bg-slate-800">Restaurar</button>
            </div>
          </aside>

          <main className="lg:col-span-2 space-y-4">
            <div className="card card-anim">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-sm text-gray-500">Saldo (m√™s selecionado)</div>
                  <div className={`text-2xl font-bold ${totalForMonth >= 0 ? 'text-green-600' : 'text-red-500'}`}>R$ {totalForMonth.toFixed(2)}</div>
                  <div className="text-xs text-gray-500 mt-1">{transactionsForMonth.length} transa√ß√µes</div>
                </div>

                <div className="w-64">
                  <div className="text-sm text-gray-500">Resumo</div>
                  <div className="mt-1 text-sm">
                    <div>Receitas: R$ {transactionsForMonth.filter(t=>t.type==='income').reduce((s,t)=> s + t.amount,0).toFixed(2)}</div>
                    <div>Despesas: R$ {transactionsForMonth.filter(t=>t.type==='expense').reduce((s,t)=> s + t.amount,0).toFixed(2)}</div>
                  </div>
                </div>
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h4 className="text-sm font-medium mb-2">Despesas por categoria</h4>
                  <PieCanvas data={byCategoryForMonth} />
                </div>
                <div>
                  <h4 className="text-sm font-medium mb-2">Fluxo por dia</h4>
                  <BarCanvas data={barDataForMonth} />
                </div>
              </div>
            </div>

            <TransactionList transactions={transactionsForMonth} onEdit={(t)=> setEditing(t)} onDelete={deleteTransaction} onToggleFixed={toggleFixed} />
          </main>
        </div>

        <footer className="mt-6 text-center text-sm text-gray-500">¬© 2025 Italo Rocha</footer>
      </div>
    </div>
  );
}

/* ---------- render ---------- */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
